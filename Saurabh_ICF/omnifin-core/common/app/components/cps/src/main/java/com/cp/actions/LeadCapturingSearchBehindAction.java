/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.cp.actions;

import java.util.ArrayList;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.log4j.Logger;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.validator.DynaValidatorForm;

import com.business.CPClient.LeadProcessingRemote;
import com.connect.LookUpInstanceFactory;
import com.cp.vo.CreditProcessingLeadDetailDataVo;
import com.cp.vo.LeadCaptureVo;
import com.login.dao.UserSessionCheck;
import com.login.roleManager.UserObject;


	public class LeadCapturingSearchBehindAction extends Action {
		private static final Logger logger = Logger.getLogger(LeadCapturingSearchBehindAction.class.getName());
            public ActionForward execute(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) throws Exception {
        		HttpSession session = request.getSession();
        		String leadno = "";
        		
        		UserObject userobj = (UserObject) session.getAttribute("userobject");
        		if(userobj==null){
    				logger.info("here in execute method of LeadCapturingSearchBehindAction action the session is out----------------");
    				return mapping.findForward("sessionOut");
    			}
        		String sessionId = session.getAttribute("sessionID").toString();

        		ServletContext context = getServlet().getServletContext();
        		String strFlag="";	
        		if(sessionId!=null)
        		{
        			strFlag = UserSessionCheck.checkSameUserSession(userobj,sessionId.toString(),"",request);
        		}
        		
        	
        		if(!strFlag.equalsIgnoreCase(""))
        		{
        			if(strFlag.equalsIgnoreCase("sameUserSession"))
        			{
        				context.removeAttribute("msg");
        				context.removeAttribute("msg1");
        			}
        			else if(strFlag.equalsIgnoreCase("BODCheck"))
        			{
        				context.setAttribute("msg", "B");
        			}
        			return mapping.findForward("logout");
        		}
			
			if(session.getAttribute("leadno")!=null)
			{
				leadno=session.getAttribute("leadno").toString();
			}
			else if(session.getAttribute("maxId")!=null)
			{
				leadno=session.getAttribute("maxId").toString();
			}
			String leadCapt = request.getParameter("leadno");
			logger.info("||||||||||||||||LEAD_____NO||||||||||||||||||||" + leadCapt);
			logger.info("###################################: " +session.getAttribute("allocationid"));
			logger.info("In LeadCapturingSearchBehindAction  execute id: " +session);
			
			LeadCaptureVo ob= new LeadCaptureVo();
			String tracking = (String) session.getAttribute("leadpageid");

			DynaValidatorForm LeadProcessingDynaValidatorForm= (DynaValidatorForm)form;
			org.apache.commons.beanutils.BeanUtils.copyProperties(ob, LeadProcessingDynaValidatorForm);
			 	
			 LeadProcessingRemote lp = (LeadProcessingRemote) LookUpInstanceFactory.getLookUpInstance(LeadProcessingRemote.REMOTE_IDENTITY, request);

			 
			if(leadCapt.equalsIgnoreCase("NEW")){
				ob.setLeadno("");
				ob.setProduct("");
				ob.setScheme("");
			}
			logger.info("###################################: "+ob.getLbxProductID());
			ArrayList<Object> getexistingData = lp.getexistingData(ob,tracking);
			
			String source = "";
			ArrayList<CreditProcessingLeadDetailDataVo> getSourceDetailList = lp.getSourceDetailList(source);
			request.setAttribute("sourceList", getSourceDetailList);
			
			if(getexistingData.size() == 0 && !leadCapt.equalsIgnoreCase("NEW")){
				String msg = "";

				msg = "N";
				request.setAttribute("message", msg);
				session.removeAttribute("list");
				session.setAttribute("leadIdData", leadCapt);
				return mapping.findForward("success");
				
			}else {
			logger.info("In LeadCapturingSearchBehindAction getexistingData().... ");
			logger.info("In LeadCapturingSearchBehindAction.........");

				//ArrayList<Object> trackData = service.getexistingData(ob,request);
				
				logger.info("Size of Lead Search List list............ "+getexistingData.size());
				if(leadCapt.equalsIgnoreCase("NEW")){
					session.removeAttribute("leadId");
					return mapping.findForward("success");
				}
				session.setAttribute("leadIdData", leadCapt);
				if(getexistingData.size()>0){
				request.setAttribute("list",getexistingData);
				request.setAttribute("track",getexistingData);
				}
		    	return mapping.findForward("success");
			}
			}
		}